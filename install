#!/bin/bash

# vefirewall

CDEF='[0m'
CRED='[1;31m'
CGRN='[1;32m'
CYEL='[1;33m'
CBLU='[1;34m'

set -euo pipefail

if [[ "$UID" != 0 ]]; then
	echo "${CRED}You are not root$CDEF"
	exit 127
fi

if [[ -f /usr/bin/vefirewall ]]; then
	read -p "${CYEL}Are you sure you want to replace /usr/bin/vefirewall ? y/N ${CDEF}" RES
	[[ $RES =~ y ]] && {
		if [[ $(grep 'NS=https://github.com/taikedz/vefirewall' /usr/bin/vefirewall -c) -gt 0 ]]; then
			cp bin/vefirewall /usr/bin/
		else
			echo -e "${CRED}/usr/bin/firewall does not seem to be the program expected.\n\n${CYEL}Abort - inspect with 'diff bin/vefirewall /usr/bin/vefirewall | less'$CDEF" 1>&2
			exit 126
		fi
	}
elif [[ $(which vefirewall > /dev/null 2>&1 ; echo $?) -lt 0 ]]; then # exists elsewhere
	echo "${CRED}$(which firewall) already exists$CDEF - remove it before continnuing"
else
	cp bin/vefirewall /usr/bin/
fi

cp -r examples/vefw /etc/
chmod 744 /etc/vefw/{inputs,outputs,policy,banned}
